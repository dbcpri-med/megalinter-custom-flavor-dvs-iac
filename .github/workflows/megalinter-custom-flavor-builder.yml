# =============================================================
# Build MegaLinter Custom Flavor Workflow
#
# This workflow builds and publishes a custom MegaLinter Docker image
# to GitHub Container Registry (ghcr.io) and optionally Docker Hub.
#
# Usage:
# - Triggers on push, release, or manual dispatch.
# - Tags the image with the release tag (on release) or 'alpha' (otherwise).
# - Pushes to ghcr.io and, if credentials are set, to Docker Hub.
#
# Required repository secrets:
#   - GITHUB_TOKEN: Provided by GitHub Actions (for ghcr.io push)
#   - DOCKERHUB_USERNAME: (optional) Docker Hub username for push
#   - DOCKERHUB_PASSWORD: (optional) Docker Hub password/token for push
#
# Optional repository variables:
#   - DOCKERHUB_REPO: Docker Hub repository name (e.g. nvuillam)
#
# The MegaLinter custom flavor image will be available at:
#   - ghcr.io/<owner>/<repo>:<tag>
#   - docker.io/<dockerhub_repo>/<repo>:<tag> (if Docker Hub credentials are set)
# =============================================================

name: Build & Push MegaLinter Custom Flavor

on:
  push:
    branches-ignore: [main]
  release:
    types: [edited, published]
  workflow_dispatch:
    inputs:
      megalinter-version:
        description: "MegaLinter version to build (e.g., v7.5.0)"
        required: false
        type: string
      is-latest:
        description: "Mark this version as latest"
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-custom-flavor:
    name: Build Custom MegaLinter Flavor
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine MegaLinter Version Tag
        id: determine-tag
        run: |
          if [ -n "${{ inputs.megalinter-version }}" ]; then
            TAG="${{ inputs.megalinter-version }}"
            echo "Using workflow input version: $TAG"
          elif [ "${{ github.event_name }}" == "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
            echo "Using release tag: $TAG"
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ inputs.is-latest }}" == "true" ]; then
            TAG="latest"
            echo "Using latest tag (is-latest=true, no version specified): $TAG"
          else
            TAG="beta"
            echo "Using default tag: $TAG"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # Determine is-latest flag
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            IS_LATEST="${{ inputs.is-latest }}"
            echo "Using workflow input is-latest: $IS_LATEST"
          elif [ "${{ github.event_name }}" == "release" ]; then
            IS_LATEST="true"
            echo "Release event - is-latest: true"
          else
            IS_LATEST="false"
            echo "Default is-latest: false"
          fi
          echo "is-latest=$IS_LATEST" >> $GITHUB_OUTPUT

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Log in to Docker Hub only if credentials are provided
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
        continue-on-error: true

      - name: Build MegaLinter Custom Flavor
        uses: oxsecurity/megalinter/flavors/custom-builder@main
        with:
          megalinter-custom-flavor-builder-tag: ${{ steps.determine-tag.outputs.tag }}
          is-latest: ${{ steps.determine-tag.outputs.is-latest }}
          upload-to-ghcr: "true"
          upload-to-dockerhub: ${{ secrets.DOCKERHUB_USERNAME != '' && secrets.DOCKERHUB_PASSWORD != '' && 'true' || 'false' }}
          dockerhub-repo: ${{ vars.DOCKERHUB_REPO }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CUSTOM_FLAVOR_BUILD_REPO: ${{ github.repository }}
          CUSTOM_FLAVOR_BUILD_REPO_URL: ${{ github.repositoryUrl }}
          CUSTOM_FLAVOR_BUILD_USER: ${{ github.actor }}

      # Workaround for pkg_resources missing in Python 3.13 (azure-devops SDK dependency).
      # The upstream fix is oxsecurity/megalinter#7151 (merged 2026-02-16) but not yet
      # in a released image. Pull the just-pushed image, layer setuptools on top,
      # and push again to overwrite the tag.
      # TODO: Remove this step once MegaLinter releases a version with the fix.
      - name: Patch image - install setuptools for Python 3.13 compatibility
        run: |
          TAG="${{ steps.determine-tag.outputs.tag }}"
          IMAGE="ghcr.io/${{ github.repository }}/megalinter-custom-flavor:${TAG}"

          docker pull "$IMAGE"

          printf 'FROM %s\nRUN pip install --no-cache-dir setuptools\n' "$IMAGE" \
            | docker build -t "$IMAGE" -

          docker push "$IMAGE"

          if [ "${{ steps.determine-tag.outputs.is-latest }}" == "true" ] && [ "$TAG" != "latest" ]; then
            LATEST_IMAGE="ghcr.io/${{ github.repository }}/megalinter-custom-flavor:latest"
            docker tag "$IMAGE" "$LATEST_IMAGE"
            docker push "$LATEST_IMAGE"
          fi

      # The two-step push (builder then patch) leaves an orphaned untagged SHA entry.
      # Delete all untagged package versions to keep GHCR tidy.
      - name: Delete untagged package versions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ORG="${{ github.repository_owner }}"
          # Slash in package name must be URL-encoded
          PACKAGE="${{ github.event.repository.name }}%2Fmegalinter-custom-flavor"

          gh api \
            -H "Accept: application/vnd.github+json" \
            "/orgs/${ORG}/packages/container/${PACKAGE}/versions?per_page=100" \
            --jq '.[] | select(.metadata.container.tags | length == 0) | .id' \
          | while read -r version_id; do
            echo "Deleting untagged version: ${version_id}"
            gh api \
              --method DELETE \
              -H "Accept: application/vnd.github+json" \
              "/orgs/${ORG}/packages/container/${PACKAGE}/versions/${version_id}"
          done
          echo "Cleanup complete"
